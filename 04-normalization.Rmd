# Normalizing and centering data {#normalization}
We utilize `bayNorm` (Tang et al., Bioinformatics, 2020) and log transformation
after the addition of pseudo counts to normalize UMI-based scRNA-seq data.
Additionally, we transform the log-normalized read counts by subtracting with
the mean expression across cells.
The resulting normalized and centered data will be used for downstream
analyses.

Load the data.
```{r, eval = FALSE}
rm(list = ls())
source("R/function_general.R")
sc68_vehi <- readRDS(file = "backup/01_004_sc68_vehi_trim_variables.rds")
sc68_cisp <- readRDS(file = "backup/02_004_sc68_cisp_trim_variables.rds")
pdac_ast1 <- readRDS(file = "backup/05_004_pdac_ast1_trim_variables.rds")
pdac_arna <- readRDS(file = "backup/06_004_pdac_arna_trim_variables.rds")
pbmc_4000 <- readRDS(file = "backup/10_004_pbmc_4000_trim_variables.rds")
pbmc_6000 <- readRDS(file = "backup/11_004_pbmc_6000_trim_variables.rds")
```

Check the size of the gene-by-sample matrices.
```{r, eval = FALSE}
rbind(dim(sc68_vehi[["data"]][["raw"]]), dim(sc68_cisp[["data"]][["raw"]]),
      dim(pdac_ast1[["data"]][["raw"]]), dim(pdac_arna[["data"]][["raw"]]),
      dim(pbmc_4000[["data"]][["raw"]]), dim(pbmc_6000[["data"]][["raw"]]))
```

```
[1,] 6581 3923
[2,] 6347 2285
[3,] 4497  428
[4,] 5893 2051
[5,] 6658 3815
[6,] 5169 4878
```

Perform `bayNorm()` to infer the true copy numbers of transcripts.
Below is the default setting of `bayNorm()`.
```{r, eval = FALSE}
doBayNorm <- function(obj){
  MeanBETA = 0.06  # 0.06 is the default value
  obj[["history"]][["doBayNorm"]][["MeanBETA"]] <- MeanBETA
  mat <- as.matrix(obj[["data"]][["raw"]])
  BETA <- BetaFun(Data = mat, MeanBETA = MeanBETA)
  bay_out <- bayNorm(mat, BETA_vec = BETA[["BETA"]], mode_version = TRUE)
  obj[["data"]][["bayNorm"]] <- bay_out
  return(obj)
}

sc68_vehi <- doBayNorm(obj = sc68_vehi)
sc68_cisp <- doBayNorm(obj = sc68_cisp)
pdac_ast1 <- doBayNorm(obj = pdac_ast1)
pdac_arna <- doBayNorm(obj = pdac_arna)
pbmc_4000 <- doBayNorm(obj = pbmc_4000)
pbmc_6000 <- doBayNorm(obj = pbmc_6000)
```

The following function `log1p_data()` performs log (natural logarithm)
transform of the input data with a pseudo count `eps`.
```{r, eval = FALSE}
log1p_data <- function(obj, eps){
  obj[["history"]][["log1p_data"]][["eps"]] <- eps
  mat <- as.matrix(obj[["data"]][["bayNorm"]][["Bay_out"]])
  lmat <- log(mat + eps)
  obj[["data"]][["normalized"]] <- as.data.frame(lmat)
  return(obj)
}

sc68_vehi <- log1p_data(obj = sc68_vehi, eps = 1)
sc68_cisp <- log1p_data(obj = sc68_cisp, eps = 1)
pdac_ast1 <- log1p_data(obj = pdac_ast1, eps = 1)
pdac_arna <- log1p_data(obj = pdac_arna, eps = 1)
pbmc_4000 <- log1p_data(obj = pbmc_4000, eps = 1)
pbmc_6000 <- log1p_data(obj = pbmc_6000, eps = 1)
```

The following function `center_data()` centralizes the input data on a
gene-by-gene basis.
```{r, eval = FALSE}
center_data <- function(obj){
  mat <- as.matrix(obj[["data"]][["normalized"]])
  cmat <- sweep(mat, 1, apply(mat, 1, mean), FUN = "-")
  obj[["data"]][["centered"]] <- as.data.frame(cmat)
  return(obj)
}

sc68_vehi <- center_data(obj = sc68_vehi)
sc68_cisp <- center_data(obj = sc68_cisp)
pdac_ast1 <- center_data(obj = pdac_ast1)
pdac_arna <- center_data(obj = pdac_arna)
pbmc_4000 <- center_data(obj = pbmc_4000)
pbmc_6000 <- center_data(obj = pbmc_6000)
```

Save the objects.
```{r, eval = FALSE}
saveRDS(sc68_vehi, file = "backup/01_005_sc68_vehi_normalized.rds")
saveRDS(sc68_cisp, file = "backup/02_005_sc68_cisp_normalized.rds")
saveRDS(pdac_ast1, file = "backup/05_005_pdac_ast1_normalized.rds")
saveRDS(pdac_arna, file = "backup/06_005_pdac_arna_normalized.rds")
saveRDS(pbmc_4000, file = "backup/10_005_pbmc_4000_normalized.rds")
saveRDS(pbmc_6000, file = "backup/11_005_pbmc_6000_normalized.rds")
```
